<!DOCTYPE html>
<html>
<head>
    <title>{{ torrent.name }}</title>
    <style>
        .comment {
            margin: 10px;
            padding: 10px;
            border: 1px solid gray;
        }
        .comment .meta {
            font-size: 12px;
            color: gray;
        }
        .comment .content {
            margin-top: 5px;
            margin-bottom: 5px;
        }
        .comment .vote {
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div style="text-align: right;">
        <a href="/">StableBay</a>
    </div>
    <h1>{{ torrent.name }}</h1>
    <p>Uploaded by {{ torrent.uploaded_by }} on {{ torrent.upload_date }}</p>
    <p>Category: {{ torrent.tags }}</p>
    <p>Description: {{ torrent.description }}</p>
    <p>Magnet link: <a href="{{ torrent.magnet_link }}"><img src="/static/magnet_icon.jpg" alt="Magnet Link" style="height: 30px;"></a></p>
    <p><a href="{{ url_for('edit_torrent', torrent_name=torrent.name) }}">Edit torrent</a></p>

    <form action="" method="POST">
        <label for="comment">Leave a Comment:</label>
        <textarea id="comment" name="comment" rows="4" cols="50"></textarea>
        <br>
        <button type="submit">Submit</button>
    </form>

    {% if comments %}
    <h2>Comments:</h2>
    <ul>
        {% for comment in comments %}
        <li class="comment" id="comment-{{ comment.id }}">
            <div class="meta">{{ comment.username }} - {{ comment.timestamp }} <a href="#" onclick="deleteComment('{{ comment.id }}')">Delete</a></div>
            <div class="content">{{ comment.comment }}</div>
            <div class="vote">
                <span id="vote-count-{{ comment.id }}">{{ comment.upvotes - comment.downvotes }}</span> 
                <button onclick="upvoteComment('{{ comment.id }}')" id="upvote-button-{{ comment.id }}">Upvote</button>
                <button onclick="downvoteComment('{{ comment.id }}')" id="downvote-button-{{ comment.id }}">Downvote</button>
            </div>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p>No comments yet.</p>
    {% endif %}
    <script>
        function deleteComment(commentId) {
            if (confirm("Are you sure you want to delete this comment?")) {
                fetch(`/torrents/{{ torrent.name }}/comments/${commentId}`, {
                    method: 'DELETE',
                }).then(function(response) {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Error deleting comment.');
                    }
                });
            }
        }
function upvoteComment(commentId) {
  const votedComments = JSON.parse(localStorage.getItem('votedComments')) || [];
  const index = votedComments.indexOf(commentId);
  if (index > -1) {
    votedComments.splice(index, 1);
  }

  fetch(`/torrents/{{ torrent.name }}/comments/${commentId}/upvote`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Error upvoting comment.');
    }
    return response.json();
  })
  .then(data => {
    document.querySelector(`#vote-count-${commentId}`).textContent = data.upvotes - data.downvotes;
    document.querySelector(`#upvote-button-${commentId}`).disabled = true;
    document.querySelector(`#downvote-button-${commentId}`).disabled = false;
    
    votedComments.push(commentId);
    localStorage.setItem('votedComments', JSON.stringify(votedComments));
  })
  .catch(error => {
    console.error('Error upvoting comment:', error);
    // Remove the alert message and comment out the following line to disable the dialog box
    alert(error.message);
  });
}

function downvoteComment(commentId) {
  const votedComments = JSON.parse(localStorage.getItem('votedComments')) || [];
  const index = votedComments.indexOf(commentId);
  if (index > -1) {
    votedComments.splice(index, 1);
  }

  fetch(`/torrents/{{ torrent.name }}/comments/${commentId}/downvote`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Error downvoting comment.');
    }
    return response.json();
  })
  .then(data => {
    document.querySelector(`#vote-count-${commentId}`).textContent = data.upvotes - data.downvotes;
    document.querySelector(`#downvote-button-${commentId}`).disabled = true;
    document.querySelector(`#upvote-button-${commentId}`).disabled = false;

    votedComments.push(commentId);
    localStorage.setItem('votedComments', JSON.stringify(votedComments));
  })
  .catch(error => {
    console.error('Error downvoting comment:', error);
    // Remove the alert message and comment out the following line to disable the dialog box
    alert(error.message);
  });
}

    </script>
</body>
</html>

